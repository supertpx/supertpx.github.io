---
title: JVM内存模型
date: 2019-04-09 14:38:12
categories:
- 基础
---

> JVM中的五种内存区块及其作用

### JVM内存模型

jvm内存模型图：

{% asset_img jvm内存模型.png jvm内存模型 %}

<!-- more -->

从上图中可以看到，JVM在运行时内存模型中总共可分为五个区块：程序计数器（PC Register）、虚拟机栈（JVM stack）、本地方法栈（native method stack）、堆（heap）、方法区（method area），其中方法区里还包含运行时常量池（runtime constant pool）。程序计数器、虚拟机栈、本地方法栈这三者是线程私有的，而堆是线程公有的。

#### 程序计数器

程序计数器是最小的一块内存区域，它的作用是当前线程所执行的字节码的行号指示器，在虚拟机的模型里，字节码解释器工作时就是通过改变这个计数器的值来选取下一条需要执行的字节码指令，分支、循环、异常处理、线程恢复等基础功能都需要依赖计数器完成。程序计数器是唯一一块不存在OutOfMemoryError异常的区域。

#### 虚拟机栈

虚拟机栈由线程私有，由此可知这块内存区域存有跟方法运行时相关的一些私有变量（局部变量）。每个方法被执行的时候都会创建一个"栈帧",用于存储局部变量表(包括参数)、操作栈、方法出口等信息。每个方法被调用到执行完的过程，就对应着一个栈帧在虚拟机栈中从入栈到出栈的过程。声明周期与线程相同，是线程私有的。栈帧由三部分组成：局部变量区、操作数栈、帧数据区。局部变量区被组织为以一个字长为单位、从0开始计数的数组，和局部变量区一样，操作数栈也被组织成一个以字长为单位的数组。但和前者不同的是，它不是通过索引来访问的，而是通过入栈和出栈来访问的，可以看作为临时数据的存储区域。除了局部变量区和操作数栈外，java栈帧还需要一些数据来支持常量池解析、正常方法返回以及异常派发机制。这些数据都保存在java栈帧的帧数据区中。该区可以抛出StackOverflowError或OutOfMemoryError异常。

#### 本地方法栈

与虚拟机栈基本类似，区别在于虚拟机栈为虚拟机执行的java方法服务，而本地方法栈则是为Native方法服务。

#### 堆

是java虚拟机所管理的内存中最大的一块内存区域，该内存区域存放了对象实例及数组（但不是所有的对象实例都在堆中）。其大小通过-Xms(最小值)和-Xmx(最大值)参数设置（最大最小值都要小于1G），前者为启动时申请的最小内存，默认为操作系统物理内存的1/64，后者为JVM可申请的最大内存,默认为物理内存的1/4，默认当空余堆内存小于40%时，JVM会增大堆内存到-Xmx指定的大小，可通过-XX:MinHeapFreeRation=来指定这个比列；当空余堆内存大于70%时，JVM会减小堆内存的大小到-Xms指定的大小，可通过XX:MaxHeapFreeRation=来指定这个比列，当然为了避免在运行时频繁调整Heap的大小，通常-Xms与-Xmx的值设成一样。该区可以抛出OutOfMemoryError异常。

堆内存 = 新生代+老生代+持久代。在我们垃圾回收的时候，我们往往将堆内存分成新生代和老生代（大小比例1：2），新生代中由Eden和Survivor0，Survivor1组成，三者的比例是8：1：1，新生代的回收机制采用复制算法，在Minor GC的时候，我们都留一个存活区用来存放存活的对象，真正进行的区域是Eden+其中一个存活区，当我们的对象时长超过一定年龄时（默认15，可以通过参数设置），将会把对象放入老生代，当然大的对象会直接进入老生代。老生代采用的回收算法是标记整理算法。

#### 方法区

方法区也称"永久代"，它用于存储虚拟机加载的类信息、常量、静态变量。默认最小值为16MB，最大值为64MB（64位JVM由于指针膨胀，默认是85M），可以通过-XX:PermSize 和 -XX:MaxPermSize 参数限制方法区的大小。它是一片连续的堆空间，永久代的垃圾收集是和老年代(old generation)捆绑在一起的，因此无论谁满了，都会触发永久代和老年代的垃圾收集。该区可以抛出OutOfMemoryError异常。

运行时常量池：是方法区的一部分，Class文件中除了有类的版本、字段、方法、接口等描述信息外，还有一项信息是常量池，用于存放编译器生成的各种符号引用，这部分内容将在类加载后放到方法区的运行时常量池中。

### 参考文献

- [JVM内存模型与垃圾回收](https://www.cnblogs.com/xing901022/p/7725961.html)
- [深入理解java虚拟机](http://www.cnblogs.com/prayers/p/5515245.html)